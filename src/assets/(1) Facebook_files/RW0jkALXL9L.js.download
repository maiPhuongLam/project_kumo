;/*FB_PKG_DELIM*/

__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["LSDatabaseSingleton","LSVec","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,b,d,e,f,g,j,k,l,m,n,o){return i.load().then(function(a){c("promiseDone")((h||(h=c("LSDatabaseSingleton"))).then(function(c){return c.runInTransaction(function(c){return a.call(c,b,d,e,f,g,j,k,l,m,n,o)},"readwrite")}));return[c("LSVec").ofArray([]),c("LSVec").ofArray([]),!1]})}g.call=a}),98);
__d("LSUpdateOptimisticContextThreadKeys",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.sequence([function(c){return b.forEach(b.filter(b.db.table(32).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})},function(c){return b.forEach(b.filter(b.db.table(31).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})}])},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSUpdateTaskQueueName",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.forEach(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b.item;return c({queueName:a[1]})})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSUpdateTaskValue",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.forEach(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b=b.item;return c({taskValue:b.taskValue.split(a[1]).join(a[2])})})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSCreateOpenToE2EEThreadLink",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(193).put({openThreadId:a[0],armadilloThreadId:a[1],showOpenMessageHistory:a[2],timestampMs:a[3]})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSShimHybridThreadDeleteUtil",["Promise","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table")).getKeyRange(b)).then(function(a){return a})}function c(a,c){if(c!=null)return(h||(h=b("Promise"))).all([a.table("threads")["delete"](c.serverThreadKey),a.table("mi_act_mapping_table")["delete"](c.serverThreadKey,c.clientThreadPk,c.jid)]).then(function(){});else return(h||(h=b("Promise"))).resolve()}g.getMiActMappingRow=a;g.deleteE2EEMetadataTable=c}),98);
__d("LSShimHybridThreadDeleteByThreadKey.nop",["LSShimHybridThreadDeleteUtil","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){b=(yield d("LSShimHybridThreadDeleteUtil").getMiActMappingRow(a,c));return d("LSShimHybridThreadDeleteUtil").deleteE2EEMetadataTable(a,b)});function c(b,c,d){return a.apply(this,arguments)}return c}();g["default"]=a}),98);
__d("LSHybridThreadDelete",["LSShimHybridThreadDeleteByThreadKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[];return c.sequence([function(d){return c.nativeOperation(b("LSShimHybridThreadDeleteByThreadKey.nop"),a[0])},function(a){return c.resolve(d)}])}e.exports=a}),null);
__d("LSTransportHybridParticipantUpdateReceipts",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.resolve(c)}e.exports=a}),null);
__d("LSUpdateOccamadilloMostRecentMessagePerThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(292).fetch([[[a[0]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?b.db.table(292).add({threadKey:a[0],timestampMs:a[1]}):(c.item,0)})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSReplaceOptimisticThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(9).fetch([[[a[1]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?b.forEach(b.filter(b.db.table(9).fetch([[[a[0]]]]),function(c){return b.i64.eq(c.threadKey,a[0])&&b.i64.le(c.authorityLevel,b.i64.cast([0,20]))}),function(c){var d=c.update;c.item;return d({threadKey:a[1],authorityLevel:b.i64.cast([0,40])})}):(c.item,b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){return a["delete"]()}))})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSShimGetServerThreadKeyFromJIDV2.nop",["ReQL","RetUtil","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){b=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table").index("jid")).getKeyRange(c)));return d("RetUtil").getNullableRetResult(b==null?void 0:b.serverThreadKey)});function c(b,c,d){return a.apply(this,arguments)}return c}();g["default"]=a}),98);
__d("LSUpdateThreadAuthorityAndMapping",["LSDeleteThread","LSReplaceOptimisticThread","LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateOptimisticContextThreadKeys","LSUpdateTaskQueueName","LSUpdateTaskValue"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.nativeOperation(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(b){return c.db.table(9).fetch([[[a[1]]]]).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(b){return c.filter(c.db.table(9).fetch(),function(b){return c.i64.eq(b.threadKey,a[2])}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(e){return d[5]=c.i64.neq(d[0],void 0),d[7]=c.i64.eq(d[0],a[2])&&d[5],!d[7]&&!(c.i64.eq(d[0],a[1])&&d[5])&&d[5]?function(a){c.logger(a).mustfix(a)}("The mi_act_mapping row did not correspond to either the authoritative or optimistic thread key."):0,c.i64.neq(a[2],void 0)?d[6]=a[2]:d[6]=c.i64.cast([0,0]),d[5]?d[7]?c.sequence([function(e){return d[1]?c.storedProcedure(b("LSDeleteThread"),a[1],!1):c.resolve()},function(a){return c.i64.neq(d[6],void 0)?c.forEach(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.storedProcedure(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.storedProcedure(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):d[3]?c.storedProcedure(b("LSDeleteThread"),d[6],!1):c.resolve():d[3]?d[1]?c.storedProcedure(b("LSDeleteThread"),d[6],!1):c.sequence([function(a){return c.i64.neq(d[6],void 0)?c.forEach(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.storedProcedure(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.storedProcedure(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):c.resolve()},function(e){return d[3]?c.sequence([function(e){return d[9]=c.i64.to_string(d[6]),d[8]=c.i64.to_string(a[1]),c.storedProcedure(b("LSUpdateTaskQueueName"),d[9],d[8])},function(a){return c.storedProcedure(b("LSUpdateTaskValue"),d[8],d[9],d[8])}]):c.resolve()}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSUpdateThreadAuthorityAndMappingWithOTIDFromJID",["LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateThreadAuthorityAndMapping"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return c.nativeOperation(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(e){return c.i64.neq(d[0],a[1])?d[1]=d[0]:d[1]=void 0,c.storedProcedure(b("LSUpdateThreadAuthorityAndMapping"),a[0],a[1],d[1])}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSShimVerifyThreadExists.nop",["I64","LSAuthorityLevel","LSContactGender","LSContactIdType","LSContactType","LSContactViewerRelationship","LSContactWorkForeignEntityType","LSFactory","LSGroupParticipantJoinState","LSIntEnum","LSVec","LSVerifyContactRowExistsStoredProcedure","MAWMiActCreateThreadInActWithMiData","Promise","ReQL","WALoggerDeferred","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Occamadillo] MI thread insertion for fbid: "," with last activity timestamp: "," and last read timestamp: ",", read = ",""]);k=function(){return a};return a}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){yield (j||(j=b("Promise"))).all(c("LSVec").toArray(f).map(function(b){return c("LSVerifyContactRowExistsStoredProcedure")(c("LSFactory")(a),{authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),blockedByViewerStatus:h.ofNumber(0),contactIdType:h.ofNumber(c("LSContactIdType").FBID),contactType:h.ofNumber(c("LSContactType").USER),contactViewerRelationship:h.ofNumber(c("LSContactViewerRelationship").UNKNOWN),gender:h.ofNumber(c("LSContactGender").UNKNOWN),id:b,isBlocked:!1,isMemorialized:!1,isSelf:!1,workForeignEntityType:h.ofNumber(c("LSContactWorkForeignEntityType").UNKNOWN)}).then(function(){return a.table("participants").put({authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),contactId:b,deliveredWatermarkTimestampMs:(i||(i=d("I64"))).zero,groupParticipantJoinState:h.ofNumber(c("LSGroupParticipantJoinState").MEMBER),isModerator:!1,readActionTimestampMs:i.zero,readWatermarkTimestampMs:i.zero,threadKey:e})})}))});return m.apply(this,arguments)}function n(a,b,c){return a.table("mi_act_mapping_table").put({clientThreadPk:(i||(i=d("I64"))).neg(b),jid:c,serverThreadKey:b})}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,j,m,o){b=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table")).getKeyRange(e)));b==null&&(yield n(a,e,f));c("promiseDone")(d("WALoggerDeferred").LOG(k(),(i||(i=d("I64"))).to_string(e),i.to_string(m),i.to_string(o),i.le(m,o)));yield l(a,e,g);c("promiseDone")(d("MAWMiActCreateThreadInActWithMiData").miActCreateThreadInActWithMiData(e,f,m,o,j));return});function e(b,c,d,e,f,g,h,i,j){return a.apply(this,arguments)}return e}();g["default"]=a}),98);
__d("LSVerifyHybridThreadExists",["LSShimVerifyThreadExists.nop","LSVerifyE2EEMetadataThreadExistsV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return c.storedProcedure(b("LSVerifyE2EEMetadataThreadExistsV2"),a[2],a[0],c.i64.cast([0,60])).then(function(a){return a=a,d[0]=a[0],a})},function(b){return d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[11],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[4]=!1:(e=b.item,d[7]=e.deviceId,c.i64.neq(d[7],void 0)?d[6]=c.i64.neq(d[7],a[11]):d[6]=!1,d[4]=d[6])})},function(a){return d[2]=d[4]}]):c.resolve(d[2]=!1)},function(e){return d[2]?d[3]=!0:d[3]=a[8],c.nativeOperation(b("LSShimVerifyThreadExists.nop"),a[0],a[1],a[3],a[4],a[5],a[6],a[7])},function(a){return e[0]=c.i64.cast([0,0])}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSSymmetricEncryptionCreateDecryptedData.nop",["CryptoLogger","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","Promise","RetUtil","SymmetricEncryptionPaddingUtils","XPlatReactCrypto"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_data");a=function(a,c,e,f,g){if(g.byteLength<d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes){i.mustfix("cipher text is invalid");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult())}a=new Uint8Array(g);var j=a.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes);c=new(d("HChaCha20").HChaCha20)();var k=a.slice(d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer;g=c.hChaCha20Bytes(j.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,e);return d("XPlatReactCrypto").subtleImportKey("raw",g,"AES-GCM",!1,["decrypt"]).then(function(a){return d("XPlatReactCrypto").subtleDecrypt({additionalData:f,iv:new Uint8Array(j.slice(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},a,k)}).then(function(a){a=d("SymmetricEncryptionPaddingUtils").stripPadding(a);a==null&&i.mustfix("Failed to strip padding for symmetric decryption");return d("RetUtil").getNullableRetResult(a)})["catch"](function(a){d("CryptoLogger").captureError(i,a).mustfix("symmetric data decryption failed");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult())})};g["default"]=a}),98);
__d("LSSymmetricEncryptionCreateDecryptedString.nop",["Base64Utils","CryptoLogger","LSResult","LSSymmetricEncryptionCreateDecryptedData.nop","XPlatReactTextDecoder"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return c("LSResult")(a)}a=function(a,b,e,f,g){var i=d("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_string");g=d("Base64Utils").toArrayBuffer(g);return c("LSSymmetricEncryptionCreateDecryptedData.nop")(a,b,e,f,g).then(function(a){a=a[0];return a}).then(function(a){return a==null?h():h(new(d("XPlatReactTextDecoder").TextDecoder)().decode(a))})["catch"](function(a){d("CryptoLogger").captureError(i,a).mustfix("symmetric string decryption failed");return h()})};g["default"]=a}),98);
__d("LSDecryptMessageV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSCreateDerivedKeys.nop","LSGetBlobFromString.nop","LSIsMobileClient","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[8]=a[2]==null?c.i64.cast([0,0]):a[2],d[2]=c.i64.of_int32(a[3].length),c.i64.eq(d[2],c.i64.cast([0,1]))?c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],c.i64.cast([0,0])).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(e){return d[14]=d[12].get("epoch_anon_id"),d[12],d[15]=d[12].get("epoch_root_key"),d[12],d[16]=c.createArray(),d[26]=(d[16].push(c.i64.cast([0,32])),d[16]),c.i64.ge(d[8],c.i64.cast([0,3]))?c.resolve(d[17]=void 0):c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[17]=d[26]}])},function(e){return c.i64.ge(d[8],c.i64.cast([0,4]))?(d[26]="_",d[18]=["message_key_in_epoch",d[26],c.blobs.to_string(d[14]),d[26],"cipher_version",d[26],c.i64.to_string(d[8]),d[26],"thread",d[26],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,3]))?(d[27]="_",d[26]=["message_key_in_epoch",d[27],c.blobs.to_string(d[14]),d[27],"cipher_version",d[27],c.i64.to_string(d[8]),d[27],"thread",d[27],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,2]))?(d[28]="_",d[27]=["message_key_in_epoch",d[28],c.blobs.to_string(d[14]),d[28],"cipher_version",d[28],c.i64.to_string(d[8])].join("")):d[27]=["message_key_in_epoch","_",c.blobs.to_string(d[14])].join(""),d[26]=d[27]),d[18]=d[26]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[18]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[19],d[17],d[15],d[16]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!1:d[21]=!0,d[21]?c.resolve(d[22]=void 0):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[22]=d[26]}])},function(e){return c.blobs.neq(d[22],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[22],c.blobs.of_string(["message_thread","_",a[1]].join("")),a[0]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[26]!==void 0?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[28]=["Failed to decrypt message. Epoch Anon ID: ",c.blobs.to_string(d[14]),", Encryption Version: ",c.i64.to_string(d[8])].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] ","",d[28]].join("")),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure",[d[28]].join(""),d[29],c.i64.cast([0,3]))},function(a){return d[27]=void 0}])},function(a){return d[23]=d[27]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null"),void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),"[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null",void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[26]=c.createArray(),void 0!==void 0?d[27]=(d[26].push(void 0),d[26]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure","Decryption message key is null",d[26],c.i64.cast([0,3]))},function(a){return d[23]=void 0}])},function(a){return d[23]!==void 0?(a=[d[23],void 0],d[24]=a[0],d[25]=a[1],a):(d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,101])),d[26].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[24]=a[0],d[25]=a[1],a),a=[d[24],d[25]],d[3]=a[0],d[4]=a[1],a}]):c.resolve((d[12]=c.i64.of_int32(a[3].length),c.i64.eq(d[12],c.i64.cast([0,0]))?(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,102])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e):(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,103])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e),e=[d[13],d[14]],d[3]=e[0],d[4]=e[1],e))},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[11]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageV2] ",d[7],d[9],d[7],d[10],d[7],d[11]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageV2",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[3],d[4]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSBase64Decode.nop",["Base64Utils","CryptoLogger","LSResult","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){a=a.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","=");var b=4-a.length%4;if(b<4)for(var c=0;c<b;c++)a+="=";return a}function j(a){var b=d("CryptoLogger").CryptoLogger("base64decode");try{return a!=null?d("Base64Utils").toArrayBuffer(i(a)):void 0}catch(c){if((c==null?void 0:c.message)==null)return;if(c instanceof Error)b.catching(c).mustfix(c.message);else{b.mustfix("Base64decode : empty error message for exception: %s, input string: %s",c.message,(b=a)!=null?b:"undefined")}}}a=function(a,d,e){return(h||(h=b("Promise"))).resolve(c("LSResult")(j(e)))};g["default"]=a}),98);
__d("LSDecryptMessages",["LSArrayGetObjectAt","LSBase64Decode.nop","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSDecryptMessageV2","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessages] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,1])),d[11].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[11].set("error_message",""),g=[void 0,d[11]],d[2]=g[0],d[3]=g[1],g):(f=e.item,c.sequence([function(a){return d[18]=f.backupId,d[19]=f.deviceId,d[17]=f.backupTenancy,d[16]=f.encryptionVersion,c.i64.neq(void 0,void 0)?c.resolve(d[11]=void 0):c.sequence([function(a){return d[20]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[30]=(d[20].push(c.i64.cast([0,0])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[22]?d[30]=(d[20].push(c.i64.cast([0,2])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[23]?d[30]=(d[20].push(c.i64.cast([0,3])),d[20]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[24]=a[0],a})},function(a){return d[24]?d[30]=(d[20].push(c.i64.cast([0,4])),d[20]):0,d[25]=c.createArray(),d[26]=c.i64.of_int32(d[20].length),c.i64.gt(d[26],c.i64.cast([0,0]))?c.loopAsync(d[26],function(a){return d[30]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],d[30]).then(function(a){return a=a,d[31]=a[0],d[32]=a[1],a})},function(a){return d[33]=(d[25].push(d[31]),d[25])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[30]=c.createArray(),d[31]=c.i64.of_int32(d[25].length),c.i64.gt(d[31],c.i64.cast([0,0]))?c.loopAsync(d[31],function(a){return d[33]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[25],d[33]).then(function(a){return a=a,d[34]=a[0],d[35]=a[1],a})},function(a){return d[36]=(d[30].push(c.i64.to_string(d[34])),d[30])}])}):c.resolve()},function(a){return d[32]=d[30].join(","),d[27]=d[32]}])},function(a){return d[25].some(function(a){return c.i64.eq(d[16],a)})?d[28]=d[16]:d[28]=void 0,c.i64.neq(d[28],void 0)?d[29]=d[28]:d[29]=void 0,d[11]=d[29]}])},function(e){return c.i64.neq(d[11],void 0)?d[12]=d[11]:d[12]=c.i64.cast([0,0]),c.i64.neq(d[17],void 0)?d[13]=d[17]:d[13]=c.i64.cast([0,1]),c.i64.neq(d[19],void 0)?c.sequence([function(e){return d[20]=c.createArray(),d[21]=c.createArray(),d[22]=new c.Map(),d[23]=c.i64.of_int32(a[0].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.loopAsync(d[23],function(e){return d[27]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[27]).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return d[30]=d[28].get("epoch_anon_id"),d[28],d[31]=d[22].get(c.blobs.to_string(d[30])),d[22],d[31]!==void 0?c.resolve(d[32]=d[31]):c.sequence([function(a){return d[37]=d[28].get("epoch_anon_id"),d[28],d[38]=d[28].get("epoch_id"),d[28],c.i64.neq(d[38],void 0)?c.sequence([function(a){return d[43]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[38]]]]),function(a){return c.i64.eq(a.backupId,d[18])&&c.i64.eq(a.epochId,d[38])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[44]=new c.Map(),d[44].set("epoch_root_key",a.epochRootKeyBlob),d[44].set("epoch_anon_id",a.epochAnonIdBlob),d[45]=(d[43].push(d[44]),d[43])})},function(a){return d[39]=d[43]}]):c.sequence([function(a){return d[43]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[18]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[18])&&c.blobs.eq(a.epochAnonIdBlob,d[37])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[44]=new c.Map(),d[44].set("epoch_root_key",a.epochRootKeyBlob),d[44].set("epoch_anon_id",a.epochAnonIdBlob),d[45]=(d[43].push(d[44]),d[43])})},function(a){return d[39]=d[43]}])},function(a){return d[40]=c.i64.of_int32(d[39].length),c.i64.gt(d[40],c.i64.cast([0,0]))?c.resolve(d[41]=d[39]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] No epoch found. Attempting to decrypt with fallback key."),d[43]=c.createArray(),void 0!==void 0?d[56]=(d[43].push(void 0),d[43]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","No epoch found. Attempting to decrypt with fallback key.",d[43],c.i64.cast([0,3]))},function(a){return d[44]=d[28].get("fallback_encrypted_epoch_key"),d[28],c.blobs.neq(d[44],void 0)?c.sequence([function(a){return c.filter(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,c.blob("MA=="))}).next().then(function(e,h){var a=e.done;e=e.value;return a?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTableUtils] Failed to get mailbox_root_key_v2: epoch 0 is not available."),d[60]=c.createArray(),void 0!==void 0?d[61]=(d[60].push(void 0),d[60]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTableUtils","Failed to get mailbox_root_key_v2: epoch 0 is not available.",d[60],c.i64.cast([0,3]))},function(a){return d[56]=void 0}]):(h=e.item,c.sequence([function(a){return d[60]=c.createArray(),d[68]=(d[60].push(c.i64.cast([0,32])),d[60]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleT5zYWx0X21haWxib3hfcm9vdF9rZXlfdjI="),void 0,f.mailboxRootKeyBlob,d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[61]!==void 0?c.sequence([function(a){return d[68]=c.i64.of_int32(d[61].length),c.i64.ge(d[68],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[61],c.i64.cast([0,0])).then(function(a){return a=a,d[70]=a[0],d[71]=a[1],a})},function(a){return d[69]=d[70]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[70]=c.createArray(),void 0!==void 0?d[71]=(d[70].push(void 0),d[70]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[70],c.i64.cast([0,3]))},function(a){return d[69]=void 0}])},function(a){return d[62]=d[69]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[68]=c.createArray(),void 0!==void 0?d[69]=(d[68].push(void 0),d[68]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[68],c.i64.cast([0,3]))},function(a){return d[62]=void 0}])},function(a){return c.blobs.neq(d[62],void 0)?d[63]=!0:d[63]=!1,d[63]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[64]=c.createArray(),d[68]=(d[64].push(c.i64.cast([0,32])),d[64]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleT5tYWlsYm94X3Jvb3Rfa2V5X3Yy"),d[62],h.epochRootKeyBlob,d[64]).then(function(a){return a=a,d[65]=a[0],a})},function(a){return d[65]!==void 0?c.sequence([function(a){return d[68]=c.i64.of_int32(d[65].length),c.i64.ge(d[68],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[65],c.i64.cast([0,0])).then(function(a){return a=a,d[70]=a[0],d[71]=a[1],a})},function(a){return d[69]=d[70]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[70]=c.createArray(),void 0!==void 0?d[71]=(d[70].push(void 0),d[70]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[70],c.i64.cast([0,3]))},function(a){return d[69]=void 0}])},function(a){return d[66]=d[69]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[68]=c.createArray(),void 0!==void 0?d[69]=(d[68].push(void 0),d[68]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[68],c.i64.cast([0,3]))},function(a){return d[66]=void 0}])},function(a){return c.blobs.neq(d[66],void 0)?d[67]=!0:d[67]=!1,d[67]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[56]=d[66]}]))})},function(a){return c.blobs.neq(d[56],void 0)?c.sequence([function(a){return d[60]=c.createArray(),d[64]=(d[60].push(c.i64.cast([0,32])),d[60]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleV92Mj5mYWxsYmFja19rZXk="),void 0,d[56],d[60]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[61]!==void 0?c.sequence([function(a){return d[64]=c.i64.of_int32(d[61].length),c.i64.ge(d[64],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[61],c.i64.cast([0,0])).then(function(a){return a=a,d[66]=a[0],d[67]=a[1],a})},function(a){return d[65]=d[66]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[66]=c.createArray(),void 0!==void 0?d[67]=(d[66].push(void 0),d[66]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[66],c.i64.cast([0,3]))},function(a){return d[65]=void 0}])},function(a){return d[62]=d[65]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[64]=c.createArray(),void 0!==void 0?d[65]=(d[64].push(void 0),d[64]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[64],c.i64.cast([0,3]))},function(a){return d[62]=void 0}])},function(a){return c.blobs.neq(d[62],void 0)?d[63]=!0:d[63]=!1,d[63]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[58]=d[62]}]):c.resolve(d[58]=void 0)},function(a){return c.blobs.neq(d[58],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[44]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return d[60]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[58],c.blob("ZmFsbGJhY2tfZW5jcnlwdGVkX2Vwb2NoX2tleQ=="),d[60]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Decode.nop"),d[63]).then(function(a){return a=a,d[64]=a[0],a})},function(a){return d[61]=d[64]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Failed to base64-encode fallback key ciphertext. This should really never happen."),d[63]=c.createArray(),void 0!==void 0?d[64]=(d[63].push(void 0),d[63]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Failed to base64-encode fallback key ciphertext. This should really never happen.",d[63],c.i64.cast([0,3]))},function(a){return d[61]=void 0}])},function(a){return c.blobs.neq(d[61],void 0)?c.resolve((d[63]=d[28].get("epoch_anon_id"),d[28],d[64]=new c.Map(),d[64].set("epoch_anon_id",d[63]),d[64].set("epoch_root_key",d[61]),d[65]=c.createArray(),d[66]=(d[65].push(d[64]),d[65]),d[62]=d[65])):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Failed to decrypt fallback encrypted epoch key."),d[63]=c.createArray(),void 0!==void 0?d[65]=(d[63].push(void 0),d[63]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Failed to decrypt fallback encrypted epoch key.",d[63],c.i64.cast([0,3]))},function(a){return d[64]=c.createArray(),d[62]=d[64]}])},function(a){return d[59]=d[62]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Failed to get fallback key."),d[60]=c.createArray(),void 0!==void 0?d[62]=(d[60].push(void 0),d[60]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Failed to get fallback key.",d[60],c.i64.cast([0,3]))},function(a){return d[61]=c.createArray(),d[59]=d[61]}])},function(a){return d[45]=d[59]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Encrypted message has no fallback encrypted epoch key."),d[56]=c.createArray(),void 0!==void 0?d[58]=(d[56].push(void 0),d[56]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Encrypted message has no fallback encrypted epoch key.",d[56],c.i64.cast([0,3]))},function(a){return d[57]=c.createArray(),d[45]=d[57]}])},function(a){return d[49]="Epoch not found. Attempting to decrypt using fallback key.",d[50]="epoch_anon_id=",d[46]=d[28].get("epoch_anon_id"),d[28],d[52]=c.blobs.to_string(d[46]),d[53]=" decrypted_fallback_key_count=",d[47]=c.i64.of_int32(d[45].length),d[54]=c.i64.to_string(d[47]),d[48]="",function(a){c.logger(a).warn(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] ",d[48],d[49],d[48],d[50],d[48],d[52],d[48],d[53],d[48],d[54]].join("")),d[51]=",",d[55]=c.createArray(),void 0!==void 0?d[56]=(d[55].push(void 0),d[55]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure",[d[49],d[51],d[50],d[51],d[52],d[51],d[53],d[51],d[54]].join(""),d[55],c.i64.cast([0,2]))},function(a){return d[41]=d[45]}])},function(a){return d[42]=c.i64.of_int32(d[41].length),c.i64.gt(d[42],c.i64.cast([0,0]))?(d[43]=d[28].get("epoch_anon_id"),d[28],d[22].set(c.blobs.to_string(d[43]),d[41])):0,d[32]=d[41]}])},function(e){return d[33]=d[28].get("value"),d[28],d[34]=d[28].get("encryption_version"),d[28],c.storedProcedure(b("LSDecryptMessageV2"),d[33],a[1],d[34],d[32]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],a})},function(a){return d[35]!==void 0?c.resolve((d[37]=d[28].get("otid"),d[28],d[38]=new c.Map(),d[38].set("value",d[35]),d[38].set("otid",d[37]),d[39]=(d[20].push(d[38]),d[20]))):c.sequence([function(a){return d[36]!==void 0?c.sequence([function(a){return d[37]=c.i64.of_int32(d[32].length),c.i64.gt(d[37],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[32],c.i64.cast([0,0])).then(function(a){return a=a,d[48]=a[0],d[49]=a[1],a})},function(a){return d[50]=d[48].get("epoch_root_key"),d[48],d[51]=c.createArray(),d[56]=(d[51].push(c.i64.cast([0,18])),d[51]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[50],d[51]).then(function(a){return a=a,d[52]=a[0],a})},function(a){return d[52]!==void 0?c.sequence([function(a){return d[56]=c.i64.of_int32(d[52].length),c.i64.ge(d[56],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[52],c.i64.cast([0,0])).then(function(a){return a=a,d[58]=a[0],d[59]=a[1],a})},function(a){return d[57]=d[58]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[58]=c.createArray(),void 0!==void 0?d[59]=(d[58].push(void 0),d[58]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[58],c.i64.cast([0,3]))},function(a){return d[57]=void 0}])},function(a){return d[53]=d[57]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[56]=c.createArray(),void 0!==void 0?d[57]=(d[56].push(void 0),d[56]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[56],c.i64.cast([0,3]))},function(a){return d[53]=void 0}])},function(a){return c.blobs.neq(d[53],void 0)?d[54]=!0:d[54]=!1,d[54]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.blobs.neq(d[53],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[56]=a[0],a})},function(a){return d[55]=d[56]==null?"[encodingFailed]":d[56]}]):c.resolve(d[55]="[null]")},function(a){return d[38]=d[55]}]):c.resolve(d[38]="[noEpochs]")},function(a){return d[39]=d[28].get("otid"),d[28],d[40]=d[28].get("epoch_anon_id"),d[28],d[41]=d[28].get("encryption_version"),d[28],c.i64.neq(d[41],void 0)?d[42]=c.i64.to_string(d[41]):d[42]="null",d[43]=c.i64.of_int32(d[32].length),d[44]=d[28].get("epoch_fingerprint"),d[28],c.blobs.neq(d[44],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[44]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[45]=d[48]==null?"[encodingFailed]":d[48]}]):c.resolve(d[45]="[null]")},function(a){return d[46]=d[28].get("backup_id"),d[28],d[47]="",d[36].set("error_message",["Decryption failed for message with otid:",d[47],d[39],d[47]," epoch:",d[47],c.blobs.to_string(d[40]),d[47]," version:",d[47],d[42],d[47]," epoch_key_count:",d[47],c.i64.to_string(d[43]),d[47]," vsr_fingerprint:",d[47],d[45],d[47]," local_fingerprint:",d[47],d[38],d[47]," vsr_backup_id:",d[47],c.i64.to_string(d[46])==null?"[null]":c.i64.to_string(d[46]),d[47]," local_backup_id:",d[47],c.i64.to_string(d[18]),d[47]," local_device_id:",d[47],c.i64.to_string(d[19])].join(""))}]):c.resolve()},function(a){return d[37]=(d[21].push(d[36]),d[21])}])}])}):c.resolve()},function(a){return d[24]=c.i64.of_int32(d[21].length),c.i64.gt(d[24],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],c.i64.cast([0,0])).then(function(a){return a=a,d[27]=a[0],d[28]=a[1],a})},function(a){return a=[void 0,d[27]],d[25]=a[0],d[26]=a[1],a}]):c.resolve((a=[d[20],void 0],d[25]=a[0],d[26]=a[1],a))},function(a){return a=[d[25],d[26]],d[14]=a[0],d[15]=a[1],a}]):c.resolve((d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,1])),d[20].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[20].set("error_message",""),e=[void 0,d[20]],d[14]=e[0],d[15]=e[1],e))},function(a){return a=[d[14],d[15]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessages] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessages",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSRestoreEchoBlobs.nop",["I64","LSIntEnum","LSVec","MAWJobDefinitions","MAWRestoreMessagesFromEncryptedBackupsDeferred","Promise","WALogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);k=function(){return a};return a}a=function(a,e,f,g,l,m,n,o,p,q,r,s,t){c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call(a,"AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(q),c("LSVec").toArray(g).map(d("MAWJobDefinitions").toEncodedEchoMessage),l,m==null?void 0:(i||(i=d("I64"))).to_int32(m),n,o==null?void 0:(i||(i=d("I64"))).to_int32(o),p,r,s,t!=null?(j||(j=d("LSIntEnum"))).unwrapIntEnum(t):-1)["catch"](function(a){d("WALogger").ERROR(k(),a)}));return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])};g["default"]=a}),98);
__d("LSHandleMessageRestoreResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSDeleteBackupOnClient","LSIssueNewTask","LSIssuePointQueryRestoreTask","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageRestoreResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),a[7]?(d[9]="handleMessageRestoreResponse was called with instructions to delete the user's EB client state",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[9]].join("")),d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()},function(b){return c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[9]=!1:(e=b.item,d[12]=e.deviceId,c.i64.neq(d[12],void 0)?d[11]=c.i64.neq(d[12],a[6]):d[11]=!1,d[9]=d[11])})},function(a){return d[2]=d[9]}]):c.resolve(d[2]=!1)},function(e){return d[2]?(d[9]="Exiting early due to EBDevice ID mismatch",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[9]].join("")),d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.sequence([function(b){return d[9]=a[5].get("reference_timestamp"),a[5],d[10]=a[5].get("request_id"),a[5],d[11]=a[5].get("restore_task_source"),a[5],c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[18]=!1:(e=b.item,d[21]=e.deviceId,c.i64.neq(d[21],void 0)?d[20]=c.i64.neq(d[21],a[6]):d[20]=!1,d[18]=d[20])})},function(a){return d[12]=d[18]}]):c.resolve(d[12]=!1)},function(e){return d[12]?c.resolve((d[18]=new c.Map(),d[18].set("error_code",c.i64.cast([0,110])),d[18].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[18].set("error_message",""),d[13]=d[18])):c.sequence([function(e){return c.storedProcedure(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(e){return d[18]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(e){return c.i64.neq(d[21],void 0)?c.sequence([function(e){return void 0!==void 0?c.resolve(d[24]=void 0):c.sequence([function(a){return d[25]=c.createArray(),d[26]=c.i64.of_int32(d[18].length),c.i64.gt(d[26],c.i64.cast([0,0]))?c.loopAsync(d[26],function(a){return d[35]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[18],d[35]).then(function(a){return a=a,d[36]=a[0],d[37]=a[1],a})},function(a){return d[38]=d[36].get("value"),d[36],d[39]=(d[25].push(d[38]),d[25])}])}):c.resolve()},function(e){return d[27]=a[1].get("has_more_before"),a[1],d[28]=a[1].get("next_message_timestamp_ms_before"),a[1],d[29]=a[1].get("has_more_after"),a[1],d[30]=a[1].get("next_message_timestamp_ms_after"),a[1],c.nativeOperation(b("LSRestoreEchoBlobs.nop"),d[21],d[25],d[27],d[28],d[29],d[30],a[4],a[2],d[10],d[9],d[11]).then(function(a){return a=a,d[31]=a[0],d[32]=a[1],d[33]=a[2],a})},function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[10],void 0,!0):c.resolve()},function(e){return d[31]?c.sequence([function(e){return d[35]=c.i64.of_int32(d[33].length),d[36]=c.i64.of_int32(d[32].length),c.i64.eq(d[36],d[35])?c.sequence([function(e){return d[38]=c.i64.cast([0,0]),d[39]=c.i64.of_int32(d[33].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.loopAsync(d[39],function(e){return d[40]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],d[40]).then(function(a){return a=a,d[41]=a[0],d[42]=a[1],a})},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[32],d[38]).then(function(a){return a=a,d[43]=a[0],d[44]=a[1],a})},function(e){return c.storedProcedure(b("LSIssuePointQueryRestoreTask"),a[2],d[43],d[41],void 0,c.i64.cast([0,35])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[38]=c.i64.add(d[38],c.i64.cast([0,1]))}])}):c.resolve()},function(a){return d[37]=void 0}]):c.resolve((d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,106])),d[38].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[38].set("error_message",""),d[37]=d[38]))},function(a){return d[34]=void 0}]):c.resolve((d[35]=new c.Map(),d[35].set("error_code",c.i64.cast([0,105])),d[35].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[35].set("error_message",""),d[34]=d[35]))},function(a){return d[24]=d[34]}])},function(a){return d[23]=d[24]}]):c.resolve(d[23]=d[22])},function(a){return d[20]=d[23]}]):c.resolve((d[19]!==void 0?(d[21]=d[19].get("error_code"),d[19],c.i64.eq(d[21],c.i64.cast([0,1]))?0:0):0,d[20]=d[19]))},function(a){return d[13]=d[20]}])},function(e){return d[13]!==void 0?c.sequence([function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[10],void 0,!0):c.resolve()},function(e){return d[18]=d[13].get("error_code"),d[13],d[19]=d[13].get("stored_procedure"),d[13],d[20]=a[5].get("restore_operation_type"),a[5],d[21]=d[13].get("error_message"),d[13],d[22]=new c.Map(),d[22].set("error_code",d[18]),d[22].set("error_message",d[21]==null?"":d[21]),d[22].set("stored_procedure",d[19]),d[23]=new c.Map(),d[23].set("act_thread_id",a[2]),d[23].set("source",d[11]),d[23].set("restore_operation_type",d[20]),d[23].set("request_id",d[10]),d[24]=new c.Map(),d[24].set("restore_context",d[23]),d[24].set("failure",d[22]),d[25]=d[24].get("restore_context"),d[24],d[26]=d[25].get("act_thread_id"),d[25],d[27]=c.toJSON(d[24]),c.storedProcedure(b("LSIssueNewTask"),["encrypted_backups_restore",":",d[26]].join(""),c.i64.cast([0,50030]),d[27],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(b){return d[28]=a[5].get("restore_operation_type"),a[5],d[29]=d[13].get("error_code"),d[13],d[30]=d[13].get("error_code"),d[13],d[31]=" ",d[14]=["Failed (",d[31],c.i64.to_string(d[30]),d[31],")"].join("")}]):c.resolve((d[18]=a[5].get("restore_operation_type"),a[5],d[14]="Succeeded"))},function(e){return d[15]="",d[16]=["Message Restore Status: ",d[15],d[14],d[15],". ACT Thread ID: ",d[15],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[16]].join("")),d[17]=c.createArray(),void 0!==void 0?d[18]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[16]].join(""),d[17],c.i64.cast([0,4]))}])},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),void 0!==void 0?d[11]=(d[10].push(void 0),d[10]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}e.exports=a}),null);
__d("LSMoveThreadToE2EECutoverFolder",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[];return b.sequence([function(c){return b.db.table(9).fetch([[[a[0]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?0:(c.item,b.forEach(b.db.table(9).fetch([[[a[0]]]]),function(a){var c=a.update;a.item;return c({folderName:"e2ee_cutover",parentThreadKey:b.i64.cast([-1,4294967279])})}))})},function(a){return b.resolve(c)}])}e.exports=a}),null);
__d("LSShimCopyAllParticipantNicknamesForThread",["gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,b=a[a.length-1],d=[];return c("gkx")("26379")===!1?0:0,b.resolve(d)}b=a;g["default"]=b}),98);